# 计算机操作系统

## 操作系统的接口

### 内核：

#### 1、基本组成

- 与硬件密切相关的操作

  与硬件相关的操作大多数是特权指令的操作

  > 现代处理器工作模式：
  >
  > | 特权级 |  0   |     1,2      |    3     |
  > | :----: | :--: | :----------: | :------: |
  > |        | 内核 | 其他系统软件 | 用户程序 |
  >
  > - DOS系统不分态
  > - Windows系统
  > 	- 3环	用户态
  > 	- 0环	系统态
  > 	- 1，2环	系统预留
  > - Unix（Linux）系统
  > 	- 00	核态
  > 	- 01	管态
  > 	- 10	用户态

- 关键数据结构

	如进程控制块**PCB**、信号量、页表等，这些数据不允许用户直接访问（需要置于内核中加以保护）

- 基本中断处理程序

	中断技术是现代计算机技术的重要组成部分

- 使用频繁的功能模块

	将使用计算机时频繁使用或操作的模块置于内核，可以提高操作系统的性能

#### 2、基本特点

- 内存常驻

	常驻（Terminate and Stay Resident, TSR）是指程序装入内存运行完成后，操作系统没有回收所占用的空间，程序仍然保留在内存当中。内核在内存中常驻有利于提高系统的性能（下次使用不用再次从磁盘中装载）

- 运行在核心态

	内核的程序运行在核心态，内核的数据也仅供核心态下程序访问。

#### 3、系统区和用户区

内存会被分割成两个部分：系统区和用户区，内核的程序和数据存放在系统区；应用程序、操作系统核外部分的程序、其他系统软件存放于用户区。**需要注意的是**，操作系统的内核可能占用内存多个不同的区域（如内存的低地址部分和高地址部分）

### 操作系统的启动

操作系统的启动依赖于一组特殊的软件，称为系统固件（System Firmware），通常固件的程序和数据存放在一个或多个只读存储器（ROM）芯片中。这些固件极其重要，是**计算机中硬件与软件沟通的桥梁**。

与PC启动有关的固件主要有BIOS（Basic Input/Output System）和UEFI（Unified EFI, Unified Extensible Firmware Interface）。

#### BIOS

##### 1、基本组成

BIOS主要包括POST（Power On Self Test）自检程序、基本启动程序、基本硬件驱动程序和中断处理程序。

1. POST自检程序

	POST自检程序又称为自诊断测试程序。主要功能是识别系统的硬件配置，并根据这些配置对系统中各部件进行自检和初始化。用户开启计算机系统的电源，机器的电源供电稳定后，处理器复位，并运行ROM BIOS的POST自检程序。

2. 基本启动程序

	主要功能是检查和运行引导程序。POST自检成功后，基本启动程序按照系统设置的优先级顺序，依次检查指定的启动设备存储介质的引导区（Boot Block）是否包含有效的操作系统引导程序。一旦发现，就将引导区中的引导程序读入**[0000:7C00]**地址开始的内存中，并执行该地址开始的引导程序

3. 基本硬件驱动程序和中断处理程序

	基本硬件驱动程序和中断处理程序指系统的基本I/O设备（如键盘、鼠标、显卡、硬盘等）的驱动程序及其基本的中断服务程序。INT 13H是磁盘操作的处理程序（在操作系统启动前，唯一的磁盘读操作的途径），INT 19H：引导装入程序、INT 10H：视频处理程序、INT 16H：键盘处理程序

##### 2、主引导记录

BIOS采用主引导记录（Master Boot Record, MBR）管理磁盘分区。

MBR结构

|     结构      | 字节偏移量/B | 字节数/B |                    说明                     |
| :-----------: | :----------: | :------: | :-----------------------------------------: |
|   BootCode    |      0       |   440    |              主引导程序（MBR）              |
| DiskSignature |     440      |    4     |            磁盘签名（signature）            |
|    Unknown    |     444      |    2     |                  [未定义]                   |
|     DPT1      |     446      |    16    |              第一个分区表DPT1               |
|     DPT2      |     462      |    16    |              第二个分区表DPT2               |
|     DPT3      |     478      |    16    |              第三个分区表DPT3               |
|     DPT4      |     494      |    16    |              第四个分区表DPT4               |
|   Signature   |     510      |    2     | 结束标志符（BRID）: 55H AAH（Magic Number） |

由上表可知，MBR结构大小刚好等于 512 B，也就是磁盘中一个扇区的宽度，在实际应用上，MBR存储在磁盘的首个扇区（0 柱面，0 磁头，1 扇区）。*注意*：在以固态硬盘（SSD）为存储介质的操作系统中，并没有扇区这一概念（不用像磁盘一样使用前需要初始化，划分扇区），所用到的固件就是UEFI。

#### UEFI

前身是由Intel公司在1997年发布的EFI，在Intel EFI 1.10的基础上于2006年发布统一可扩展固件接口UEFI 2.0 规范。

##### 基本组成

UEFI规范要比BIOS复杂得多，共包含7个[阶段](https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence)。

![](./Pictures/UEFI启动流程图.png 'UEFI启动流程图')

### 外壳

#### 基本组成

- OS的非内核部分
- 提供OS的[作业控制接口](#命令控制接口)
- 提供[系统调用接口](#程序接口及系统调用)

#### 基本特征

- 运行在用户态
- 工作在用户空间里

### 程序接口及系统调用

**系统调用**的含义：

1. 一组操作系统设计人员事先编写的子程序，并封装作为内核的一部分
2. 程序员使用这组子程序的方法

在操作系统中有设计一条特殊的指令——*访管指令*（DOS中的INT 21H，UNIX中的trap等），作用是：

1. 产生一个中断，把处理器的工作模式由原来的用户态切换为核心态
2. 执行对应的子程序
3. 子程序完成后，处理器工作模式又切换回用户态

访管指令又被称为陷入指令（traps），采用主程序/子程序的关系，按调用/返回（Call/Return）的方式实现。即处理器在执行主程序的陷入指令时，暂停主程序，转去执行（调用）对应的子程序，子程序执行完毕后返回结果给主程序，主程序恢复并继续执行。

## 处理器管理

### 作业管理

#### 作业，作业步和作业流

1. 把要求计算机处理的一个问题称为一个**作业（Job）**
	- **作业由程序、数据和作业说明书组成**
	- 作业控制语言（Job Control Language，JCL）是由操作系统提供的一组命令，程序员使用JCL命令定义作业、描述对作业的运行控制。
	- 把定义一个作业、描述对该作业运行控制的一组JCL命令组成的文件，称为**作业说明书**。操作系统有专门编码语言来编写说明书，类似于shell程序等。
2. 一个作业通常需要分成几个独立的步骤依次解决，每个独立的步骤称为一个作业步。而一个作业是若干个作业步的有序集合。
3. 若干作业的有序集合称为作业流或者一批作业。

#### 作业控制块（JCB）

系统为每个作业建立一个作业控制块（Job Control Block），表示作业的存在。

JCB基本包含：基本信息描述、控制信息描述和资源要求描述等。

<img src=".\Pictures\PCB.png" title="PCB组成" style="zoom:80%;" />

#### 命令控制接口

*命令控制接口*是由操作系统提供，用户来组织和控制作业运行的界面。也被称作作业控制接口、命令接口或操作接口。通常分为**脱机**和**联机**两种方式。

- *脱机方式*：用户向系统提供作业控制说明书或者命令文件，由系统按照[作业说明书](#作业，作业步和作业流)或命令文件中所规定的顺序控制作业的执行。
- *联机方式*：直接与系统进行交互式对话，完成作业提交。一般用户命令行、可视化窗口等都属于联机操作。

对于现代操作系统，均支持两种方式。

### 进程与线程

#### 程序

计算机程序（Computer Program）是指能够完成特定功能的一组指令（或指令）的有续集合。[^Program]

在这里可以简单理解为存储在外存中，可以被计算机直接执行的指令集合。但是也只是处于存储状态（而非执行状态），即静态数据。

##### 基本特点

1. 顺序性

	处理器在执行一个有序指令集合时，必须完全按照程序员预先指定的顺序执行，程序的功能才能得到正确的实现，即只有一条指令完成后，才能执行它的下一条指令。

2. 可再现性

	对于一道正确的程序而言，只要初始条件相同，那么在同一台机器上多次运行（即分别在不同的时间运行），最后得到的结果都应相同。若结果不同，那么应当去检查源代码是否出错。

> **顺序执行的特征**：
>
> 1. 封闭性
>
> 	即运行中的程序不受其他程序的影响（例如资源的分配）
>
> 2. 可再现性
>
> 	同程序的可再现性
>
> 典型的代表操作系统为DOS操作系统

#### 进程

一道程序在一个数据集的一次执行过程称为进程（Process）。为了进一步描述操作系统的“动态性”、实现[并发执行](#并发执行)，分析和解决并发执行中出现的问题，操作系统引入了*进程*这一概念。[^Process]

和程序相比，进程拥有“*生命周期*”，从创建到消亡，进程处于不断地动态过程中。

简单来说，程序是一系列直接存储在磁盘文件里的有序指令集合，那么进程就是指这些指令从磁盘加载到内存后的执行。

##### 主要特征

1. 动态性

	进程的动态性是指每个进程都有一个生命周期，拥有从创建、运行到消亡的过程。这个特性是进程与程序的根本区别（程序是静态的）。

2. 并发性

	多个进程可以并发执行。在一个进程的生命周期内，可以有其他进程被创建。只有多处理器的并发才是真正的并发，单处理的并发微观上仍是单进程。

	并发执行的进程简称为并发进程。

3. 独立性

	操作系统规定进程具备独立性。独立性具体表现为：**进程是操作系统分配资源的基本单位**，进程的地址空间是私有的（即一个进程的程序和数据只能由该进程本身访问），这也保证了并发进程在同一个CPU上运行时，各自都能正确地完成规定的任务。

4. 结构性

	尽管在多道程序设计中存在多个不同的进程，但这些进程仍然具有许多相同的属性，操作系统将这些属性抽象出来，定义成一个相对固定的数据结构——[进程控制块](https://en.wikipedia.org/wiki/Process_control_block)（PCB，Process Control Block）

	> PCB 进程控制块
	>
	> PCB是操作系统用来存储一个进程所有信息的数据结构，是系统感知进程存在的**唯一标志**，进程与PCB是**一一对应**的。PCB中进程的公有属性主要可以分成三类：
	>
	> 1. **描述信息**：
	>
	> 	- 进程标识符（Process ID），唯一，通常是一个整数。
	> 	- 进程名，不唯一，通常基于可执行文件名
	> 	- 用户标识符（即所属用户）
	> 	- 进程家族关系
	>
	> 2. 控制信息
	>
	> 	- 进程状态state和优先级priority
	> 	- 代码执行入口地址和程序的外存地址
	> 	- 运行统计信息：执行时间、页面调度
	> 	- 进程的队列指针
	> 	- 进程的消息队列指针：同步信号
	> 	- 资源列表：所需资源、打开文件列表等
	>
	> 3. 现场信息
	>
	> 	当进程中断时即把现场信息保存到进程控制块中，当进程再次运行时恢复现场。
	>
	> 	- 寄存器内容：通用、程序计数器PC、状态PSW，栈指针等
	> 	- 指向赋予该进程的段/页表的指针

5. 异步性

	每个进程都以各自的、不可预知的速度向前推进。

##### 进程的基本状态

1. 就绪态

	在单处理器多道程序设计中，一个处理器最多运行一个进程，其他进程则暂时处于非运行态。就绪态的进程已经得到了除处理器执行权以外的所有资源，一旦被分配到CPU执行权，就能够立即运行。

2. 运行态

	一个进程处于运行态是指处理器当前执行的指令正是该进程所对应的程序代码。运行态也被称为执行态。

3. 阻塞态

	当一个处于运行态的进程需要等待一个资源（例如，用户的输入），那么就会产生一个中断，剥夺该进程的执行权，转入阻塞状态。也就是说，阻塞态的进程即使被分配到了CPU执行权，它也无法运行。阻塞态的进程只有在无需再等待资源的情况下，才会转为就绪态，等待CPU的分配。

![](.\Pictures\Process_states.svg "Process States")

#### 并发执行

[并发](https://en.wikipedia.org/wiki/Concurrency_(computer_science))执行（Concurrence）是指在多道程序设计环境下，处理器在开始执行一道程序的第一条指令后，在这道指令完成前，处理器可以开始执行下一道程序。更专业地来讲，并发是一种能够将程序、算法或者问题分解为与顺序无关（或者部分有序）的部分组件/计算单元的能力。

##### 特点

1. 随机性

	在多道程序中，哪一道程序先运行、哪一道程序后运行、运行时能够连续执行多长时间等等是无法确定的，具有随机性。

2. 不可再现性

	由于具有随机性，多道程序在轮流地交替运行，这也就意味着，对于其中任意一道程序而言，它运行时的环境时刻都在发生变化，某些共享资源也因此变得随机。

3. 相互制约

	在多道程序使用同一个资源时，因为资源无法被同时占有，所以会影响其他程序的执行。即资源的互斥、进程死锁等（后续章节）。

多道程序的并发执行可以从两个角度解读。从*宏观*上来看，多道程序“同时”在运行，表现为多任务。因为在一个程序执行完前，处理器还可以执行其他程序，宏观上看有多个程序“同时”处于运行中。从*微观*上看，多道程序又是轮流交替地在处理器上执行。在单核处理器上，一个处理器只能在一个时刻执行一道程序。只有多核处理器地并发才是真正的并发。

[^Program]:https://en.wikipedia.org/wiki/Computer_program
[^Process]:https://en.wikipedia.org/wiki/Process_(computing)
