# 计算机操作系统

## 操作系统的接口

### 内核：

#### 1、基本组成

- 与硬件密切相关的操作

	与硬件相关的操作大多数是特权指令的操作

- 关键数据结构

	如进程控制块**PCB**、信号量、页表等，这些数据不允许用户直接访问（需要置于内核中加以保护）

- 基本中断处理程序

	中断技术是现代计算机技术的重要组成部分

- 使用频繁的功能模块

	将使用计算机时频繁使用或操作的模块置于内核，可以提高操作系统的性能

#### 2、基本特点

- 内存常驻

	常驻（Terminate and Stay Resident, TSR）是指程序装入内存运行完成后，操作系统没有回收所占用的空间，程序仍然保留在内存当中。内核在内存中常驻有利于提高系统的性能（下次使用不用再次从磁盘中装载）

- 运行在核心态

	内核的程序运行在核心态，内核的数据也仅供核心态下程序访问。

#### 3、系统区和用户区

内存会被分割成两个部分：系统区和用户区，内核的程序和数据存放在系统区；应用程序、操作系统核外部分的程序、其他系统软件存放于用户区。**需要注意的是**，操作系统的内核可能占用内存多个不同的区域（如内存的低地址部分和高地址部分）

### 操作系统的启动

操作系统的启动依赖于一组特殊的软件，称为系统固件（System Firmware），通常固件的程序和数据存放在一个或多个只读存储器（ROM）芯片中。这些固件极其重要，是**计算机中硬件与软件沟通的桥梁**。

与PC启动有关的固件主要有BIOS（Basic Input/Output System）和UEFI（Unified EFI, Unified Extensible Firmware Interface）。

#### BIOS

##### 1、基本组成

BIOS主要包括POST（Power On Self Test）自检程序、基本启动程序、基本硬件驱动程序和中断处理程序。

1. POST自检程序

	POST自检程序又称为自诊断测试程序。主要功能是识别系统的硬件配置，并根据这些配置对系统中各部件进行自检和初始化。用户开启计算机系统的电源，机器的电源供电稳定后，处理器复位，并运行ROM BIOS的POST自检程序。

2. 基本启动程序

	主要功能是检查和运行引导程序。POST自检成功后，基本启动程序按照系统设置的优先级顺序，依次检查指定的启动设备存储介质的引导区（Boot Block）是否包含有效的操作系统引导程序。一旦发现，就将引导区中的引导程序读入**[0000:7C00]**地址开始的内存中，并执行该地址开始的引导程序

3. 基本硬件驱动程序和中断处理程序

	基本硬件驱动程序和中断处理程序指系统的基本I/O设备（如键盘、鼠标、显卡、硬盘等）的驱动程序及其基本的中断服务程序。INT 13H是磁盘操作的处理程序（在操作系统启动前，唯一的磁盘读操作的途径），INT 19H：引导装入程序、INT 10H：视频处理程序、INT 16H：键盘处理程序

##### 2、主引导记录

BIOS采用主引导记录（Master Boot Record, MBR）管理磁盘分区。

MBR结构

|     结构      | 字节偏移量/B | 字节数/B |                    说明                     |
| :-----------: | :----------: | :------: | :-----------------------------------------: |
|   BootCode    |      0       |   440    |              主引导程序（MBR）              |
| DiskSignature |     440      |    4     |            磁盘签名（signature）            |
|    Unknown    |     444      |    2     |                  [未定义]                   |
|     DPT1      |     446      |    16    |              第一个分区表DPT1               |
|     DPT2      |     462      |    16    |              第二个分区表DPT2               |
|     DPT3      |     478      |    16    |              第三个分区表DPT3               |
|     DPT4      |     494      |    16    |              第四个分区表DPT4               |
|   Signature   |     510      |    2     | 结束标志符（BRID）: 55H AAH（Magic Number） |

由上表可知，MBR结构大小刚好等于 512 B，也就是磁盘中一个扇区的宽度，在实际应用上，MBR存储在磁盘的首个扇区（0 柱面，0 磁头，1 扇区）。*注意*：在以固态硬盘（SSD）为存储介质的操作系统中，并没有扇区这一概念（不用像磁盘一样使用前需要初始化，划分扇区），所用到的固件就是UEFI。

#### UEFI

前身是由Intel公司在1997年发布的EFI，在Intel EFI 1.10的基础上于2006年发布统一可扩展固件接口UEFI 2.0 规范。

##### 基本组成

UEFI规范要比BIOS复杂得多，共包含7个[阶段](https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence)。

![](./Pictures/UEFI启动流程图.png 'UEFI启动流程图')

### 外壳

#### 基本组成

- OS的非内核部分
- 提供OS的作业控制接口
- 提供系统调用接口

#### 基本特征

- 运行在用户态
- 工作在用户空间里

### 程序接口及系统调用

**系统调用**的含义：

1. 一组操作系统设计人员事先编写的子程序，并封装作为内核的一部分
2. 程序员使用这组子程序的方法

在操作系统中有设计一条特殊的指令——*访管指令*（DOS中的INT 21H，UNIX中的trap等），作用是：

1. 产生一个中断，把处理器的工作模式由原来的用户态切换为核心态
2. 执行对应的子程序
3. 子程序完成后，处理器工作模式又切换回用户态

访管指令又被称为陷入指令（traps），采用主程序/子程序的关系，按调用/返回（Call/Return）的方式实现。即处理器在执行主程序的陷入指令时，暂停主程序，转去执行（调用）对应的子程序，子程序执行完毕后返回结果给主程序，主程序恢复并继续执行。

## 处理器管理

### 作业管理

#### 作业、作业步和作业流 {#10001}

1. 把要求计算机处理的一个问题称为一个**作业（Job）**
	- **作业由程序、数据和作业说明书组成**
	- 作业控制语言（Job Control Language，JCL）是由操作系统提供的一组命令，程序员使用JCL命令定义作业、描述对作业的运行控制。
	- 把定义一个作业、描述对该作业运行控制的一组JCL命令组成的文件，称为**作业说明书**。操作系统有专门编码语言来编写说明书，类似于shell程序等。
2. 一个作业通常需要分成几个独立的步骤依次解决，每个独立的步骤称为一个作业步。而一个作业是若干个作业步的有序集合。
3. 若干作业的有序集合称为作业流或者一批作业。

#### 作业控制块（JCB）

系统为每个作业建立一个作业控制块（Job Control Block），表示作业的存在。

JCB基本包含：基本信息描述、控制信息描述和资源要求描述等。

<img src=".\Pictures\PCB.png" title="PCB组成" style="zoom:80%;" />

#### 命令控制接口

*命令控制接口*是由操作系统提供，用户来组织和控制作业运行的界面。也被称作作业控制接口、命令接口或操作接口。通常分为**脱机**和**联机**两种方式。

- *脱机方式*：用户向系统提供作业控制说明书或者命令文件，由系统按照[作业说明书](#10001)或命令文件中所规定的顺序控制作业的执行。
